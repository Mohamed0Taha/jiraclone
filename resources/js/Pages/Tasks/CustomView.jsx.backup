import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { Head } from '@inertiajs/react';
import { useChat } from '@ai-sdk/react';
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout';
import {
    Box,
    Paper,
    IconButton,
    Tooltip,
    Alert,
    Snackbar,
    Dialog,
    DialogTitle,
    DialogContent,
    DialogContentText,
    DialogActions,
    Button,
    Typography,
    Stack,
    Chip,
    alpha,
    useTheme,
    Fade,
    CircularProgress,
    LinearProgress,
    keyframes,
    TextField
} from '@mui/material';
import ChatIcon from '@mui/icons-material/Chat';
import LockIcon from '@mui/icons-material/Lock';
import LockOpenIcon from '@mui/icons-material/LockOpen';
import DeleteIcon from '@mui/icons-material/Delete';
import RefreshIcon from '@mui/icons-material/Refresh';
import SaveIcon from '@mui/icons-material/Save';
import AutoAwesomeIcon from '@mui/icons-material/AutoAwesome';
import CodeIcon from '@mui/icons-material/Code';
import BuildIcon from '@mui/icons-material/Build';
import RocketLaunchIcon from '@mui/icons-material/RocketLaunch';
import SendRoundedIcon from '@mui/icons-material/SendRounded';
import AssistantChat from './AssistantChat';
import ReactComponentRenderer from '@/utils/ReactComponentRenderer';
import { csrfFetch } from '@/utils/csrf';

// Professional design tokens inspired by Board.jsx
const designTokens = {
    gradients: {
        primary: 'linear-gradient(140deg, #F7FAFF 0%, #F2F6FE 55%, #EDF2FA 100%)',
        accent: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        success: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
        warning: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
    },
    colors: {
        primary: '#4F46E5',
        accent: '#667eea',
        success: '#10B981',
        warning: '#F59E0B',
        error: '#EF4444',
    },
    shadows: {
        card: '0 4px 16px -8px rgba(0, 0, 0, 0.1)',
        elevated: '0 8px 32px -12px rgba(0, 0, 0, 0.15)',
        floating: '0 16px 48px -16px rgba(0, 0, 0, 0.2)',
    },
    radii: {
        lg: 12,
        xl: 16,
    }
};

// Elegant animations
const pulseGlow = keyframes`
  0%, 100% { 
    box-shadow: 0 0 0 0 rgba(103, 126, 234, 0.7);
  }
  50% { 
    box-shadow: 0 0 0 10px rgba(103, 126, 234, 0);
  }
`;

const fadeSlideUp = keyframes`
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
`;

const shimmer = keyframes`
  0% {
    background-position: -200px 0;
  }
  100% {
    background-position: calc(200px + 100%) 0;
  }
`;

export default function CustomView({ auth, project, tasks, allTasks, users, methodology, viewName }) {

    const theme = useTheme();
    const [assistantOpen, setAssistantOpen] = useState(false);
    const [isLocked, setIsLocked] = useState(true);
    const [componentCode, setComponentCode] = useState('');
    const [customViewId, setCustomViewId] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [snackbar, setSnackbar] = useState({ open: false, message: '', severity: 'info' });
    const [deleteConfirmOpen, setDeleteConfirmOpen] = useState(false);
    const [componentError, setComponentError] = useState(null);
    const [isSaving, setIsSaving] = useState(false);
    const [autoSaveEnabled, setAutoSaveEnabled] = useState(true);
    const [generationProgress, setGenerationProgress] = useState(null);

    // Local input state for chat
    const [chatInput, setChatInput] = useState('');
    const [isManuallyGenerating, setIsManuallyGenerating] = useState(false);

    // AI SDK useChat hook for streaming component generation
    const {
        messages,
        input,
        handleInputChange,
        handleSubmit,
        isLoading: isGenerating,
        error: chatError,
        append,
        setMessages,
        stop,
    } = useChat({
        api: `/api/chat`,
        body: {
            projectId: project?.id,
            viewName,
            currentCode: componentCode,
            projectContext: {
                tasks,
                users,
                methodology,
            },
        },
        onResponse: (response) => {
            console.log('AI SDK Response:', response);
        },
        onFinish: (message) => {
            console.log('AI SDK Finished:', message);
            console.log('Message experimental_data:', message?.experimental_data);
            console.log('Message content:', message?.content);

            // Extract component code from the response
            if (message?.experimental_data?.component_code) {
                console.log('Found component code in experimental_data');
                setComponentCode(message.experimental_data.component_code);
                setCustomViewId(message.experimental_data.custom_view_id);
                setIsLocked(false);
                showSnackbar('Component generated successfully!', 'success');
            } else if (message?.content) {
                console.log('Checking message content for component code');
                const codeMatch = message.content.match(/```(?:jsx?|tsx?|html)?\n?([\s\S]*?)```/);
                if (codeMatch) {
                    console.log('Found component code in message content (code block)');
                    setComponentCode(codeMatch[1]);
                    setIsLocked(false);
                    showSnackbar('Component generated successfully!', 'success');
                } else if (message.content.trim() && !message.content.includes('Failed to generate')) {
                    console.log('Using entire message content as component code');
                    // If no code block found, try to use the entire content as code
                    setComponentCode(message.content);
                    setIsLocked(false);
                    showSnackbar('Component generated successfully!', 'success');
                } else {
                    console.warn('Message content appears to be an error or empty:', message.content);
                    showSnackbar('Failed to generate component. Please try again.', 'error');
                }
            } else {
                console.warn('No component code found in message');
                showSnackbar('No component code received. Please try again.', 'error');
            }
        },
        onError: (error) => {
            console.error('AI SDK Error:', error);
            showSnackbar('Failed to generate component. Please try again.', 'error');
        },
    });

    // Debug what we're getting from useChat
    // console.log('useChat hook values:', { messages, input, append, isGenerating });

    // Custom input handlers to ensure proper state management
    const handleChatInputChange = (e) => {
        // console.log('Input change:', e.target.value);
        setChatInput(e.target.value);
    };

    const handleChatSubmit = async (e) => {
        e.preventDefault();
        if (!chatInput?.trim() || isGenerating || isManuallyGenerating) return;

        try {
            const userMessage = {
                role: 'user',
                content: chatInput.trim(),
                id: Date.now().toString(),
            };

            // Add user message to chat immediately
            setMessages(prev => [...(prev || []), userMessage]);
            setChatInput(''); // Clear input immediately

            // Try using append if it exists, otherwise use manual API call
            if (typeof append === 'function') {
                await append({
                    role: 'user',
                    content: userMessage.content
                });
            } else {
                // Fallback: Manual API call
                console.log('append function not available, using manual API call');
                setIsManuallyGenerating(true);

                    // FOR TESTING: Create a simple working component
                    const testComponent = `import React, { useState, useEffect } from 'react';

function TestTaskList() {
    const [tasks, setTasks] = useState(() => tasksDataFromProps || __flatTasks || []);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    // Load data on mount
    useEffect(() => {
        const initializeData = async () => {
            try {
                console.log('Test component initializing with tasks:', tasks);
                setLoading(false);
            } catch (err) {
                setError(err.message);
                setLoading(false);
            }
        };
        initializeData();
    }, []);

    if (loading) return <div style={{padding: '20px'}}>Loading...</div>;
    if (error) return <div style={{padding: '20px', color: 'red'}}>Error: {error}</div>;

    return (
        <div style={{padding: '20px', fontFamily: 'Arial, sans-serif'}}>
            <h2>Test Task List</h2>
            <p>Found {tasks.length} tasks</p>
            {tasks.length > 0 ? (
                <table style={{width: '100%', borderCollapse: 'collapse'}}>
                    <thead>
                        <tr style={{backgroundColor: '#f5f5f5'}}>
                            <th style={{border: '1px solid #ddd', padding: '8px'}}>ID</th>
                            <th style={{border: '1px solid #ddd', padding: '8px'}}>Title</th>
                            <th style={{border: '1px solid #ddd', padding: '8px'}}>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {tasks.slice(0, 10).map((task, index) => (
                            <tr key={task.id || index}>
                                <td style={{border: '1px solid #ddd', padding: '8px'}}>{task.id}</td>
                                <td style={{border: '1px solid #ddd', padding: '8px'}}>{task.title}</td>
                                <td style={{border: '1px solid #ddd', padding: '8px'}}>{task.status}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            ) : (
                <p>No tasks found</p>
            )}
        </div>
    );
}

export default TestTaskList;`;

                    // Set the test component directly
                    setComponentCode(testComponent);
                    setIsManuallyGenerating(false);
                    showSnackbar('Test component generated successfully!', 'success');
                    return;
                }
            } catch (error) {
                console.error('Chat submit error:', error);
                showSnackbar('Failed to send message. Please try again.', 'error');
                setIsManuallyGenerating(false);
            }
        }

        /*
        // Original API call code (disabled for testing)
        const tryOriginalApiCall = async () => {
            try {
                    const response = await csrfFetch('/api/chat', {
                    method: 'POST',
                    body: JSON.stringify({
                        messages: [...(messages || []), userMessage],
                        projectId: project?.id,
                        viewName,
                        currentCode: componentCode,
                        projectContext: {
                            tasks,
                            users,
                            methodology,
                        },
                    }),
                });

                if (response.ok) {
                    const reader = response.body?.getReader();
                    const decoder = new TextDecoder();
                    let assistantMessage = '';
                    let streamedComponentCode = '';
                    let streamedCustomViewId = null;

                    if (reader) {
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n');

                            for (const line of lines) {
                                if (!line.startsWith('data: ')) continue;
                                const data = line.slice(6);
                                if (data === '[DONE]') continue;
                                try {
                                    const parsed = JSON.parse(data);
                                    if (parsed.content) assistantMessage += parsed.content;
                                    // Prefer experimental_data.component_code when present
                                    const exp = parsed.experimental_data || parsed.experimentalData || null;
                                    if (exp?.component_code && !streamedComponentCode) {
                                        streamedComponentCode = exp.component_code;
                                    }
                                    if (exp?.custom_view_id && !streamedCustomViewId) {
                                        streamedCustomViewId = exp.custom_view_id;
                                    }
                                } catch (_) {
                                    // ignore
                                }
                            }
                        }
                    }

                    // Add assistant response to messages (textual)
                    setMessages(prev => [...(prev || []), {
                        role: 'assistant',
                        content: assistantMessage,
                        id: Date.now().toString(),
                    }]);

                    // Choose code from experimental_data first, then code block, then raw fallback
                    let nextCode = streamedComponentCode;
                    if (!nextCode) {
                        const codeMatch = assistantMessage.match(/```(?:jsx?|tsx?|html)?\n?([\s\S]*?)```/);
                        if (codeMatch) nextCode = codeMatch[1];
                    }
                    if (!nextCode && assistantMessage.trim()) {
                        nextCode = assistantMessage.trim();
                    }

                    if (nextCode) {
                        setComponentCode(nextCode);
                        if (streamedCustomViewId) setCustomViewId(streamedCustomViewId);
                        setIsLocked(false);
                        showSnackbar('Component generated successfully!', 'success');
                    } else {
                        showSnackbar('Generation finished, but no component code received. Please try again.', 'warning');
                    }
                } else {
                    throw new Error('API call failed');
                }

                setIsManuallyGenerating(false);
            }
        } catch (error) {
            console.error('Chat submit error:', error);
            showSnackbar('Failed to send message. Please try again.', 'error');
            setIsManuallyGenerating(false);
        }
        */
    };

    // Enhanced save mechanism with better feedback
    const handleManualSave = async () => {
        if (!componentCode || isSaving) return;

        setIsSaving(true);
        try {
            const response = await csrfFetch(`/projects/${project.id}/custom-views/save`, {
                method: 'POST',
                body: JSON.stringify({
                    view_name: viewName,
                    component_code: componentCode,
                    custom_view_id: customViewId
                }),
            });

            if (response.ok) {
                const data = await response.json();
                setCustomViewId(data.customViewId);
                showSnackbar('Micro-application saved successfully!', 'success');
            } else {
                throw new Error('Save failed');
            }
        } catch (error) {
            console.error('Save error:', error);
            showSnackbar('Failed to save. Please try again.', 'error');
        } finally {
            setIsSaving(false);
        }
    };

    // Enhanced generation progress with detailed stages
    const getProgressIcon = (stage) => {
        switch (stage) {
            case 1: return <CodeIcon sx={{ color: designTokens.colors.primary }} />;
            case 2: return <AutoAwesomeIcon sx={{ color: designTokens.colors.accent }} />;
            case 3: return <BuildIcon sx={{ color: designTokens.colors.warning }} />;
            case 4: return <RocketLaunchIcon sx={{ color: designTokens.colors.success }} />;
            default: return <CircularProgress size={20} />;
        }
    };

    const getProgressMessage = (stage) => {
        switch (stage) {
            case 1: return 'Analyzing your requirements...';
            case 2: return 'Generating intelligent code...';
            case 3: return 'Building your application...';
            case 4: return 'Finalizing and deploying...';
            default: return 'Processing...';
        }
    };

    // Auto-save component code to prevent data loss (optimized)
    useEffect(() => {
        if (!componentCode || isLocked || !autoSaveEnabled) return;

        // Debounce auto-save to prevent excessive saves
        const timeoutId = setTimeout(() => {
            const backupKey = `microapp-backup-${project?.id || 'unknown'}-${viewName || 'default'}`;
            const backupData = {
                componentCode,
                timestamp: new Date().toISOString(),
                customViewId,
                projectId: project?.id,
                viewName: viewName || 'default'
            };
            localStorage.setItem(backupKey, JSON.stringify(backupData));
        }, 5000); // Save after 5 seconds of inactivity

        return () => {
            clearTimeout(timeoutId);
        };
    }, [componentCode, isLocked, autoSaveEnabled, project?.id, viewName, customViewId]);

    // Load existing custom view on mount (optimized)
    useEffect(() => {
        const loadCustomView = async () => {
            if (!project?.id || !viewName) {
                setIsLoading(false);
                return;
            }

            try {
                const response = await csrfFetch(`/projects/${project.id}/custom-views/get?view_name=${encodeURIComponent(viewName)}`);
                const data = await response.json();

                console.log('[CustomView] Server response:', data);
                console.log('[CustomView] HTML content:', data.html);
                console.log('[CustomView] HTML length:', data.html ? data.html.length : 0);

                if (data.success && data.html && data.html.trim()) {
                    console.log('[CustomView] Valid component found, setting component code');
                    setComponentCode(data.html);
                    setCustomViewId(data.customViewId || data.custom_view_id || null);
                    showSnackbar('Micro-application loaded successfully', 'success');
                } else {
                    console.log('[CustomView] No valid component found, falling back to empty state');
                    setComponentCode(''); // Clear any invalid component code
                    if (!data.success) {
                        console.warn('[CustomView] Failed to fetch custom view:', data.message || 'No message provided.');
                        if (!componentCode) { // Only show snackbar if there's no component rendered
                            showSnackbar(data.message || 'Could not load micro-application.', 'warning');
                        }
                    }
                    // Try to load from local backup
                    const backupKey = `microapp-backup-${project.id}-${viewName}`;
                    const backup = localStorage.getItem(backupKey);
                    if (backup) {
                        try {
                            const backupData = JSON.parse(backup);
                            if (backupData.componentCode && backupData.componentCode.trim()) {
                                setComponentCode(backupData.componentCode || '');
                                setCustomViewId(backupData.customViewId);
                            } else {
                                setComponentCode('');
                            }
                        } catch (e) {
                            setComponentCode('');
                            console.error('[CustomView] Failed to parse backup:', e);
                        }
                    } else {
                        setComponentCode('');
                    }
                }
            } catch (error) {
                console.error('[CustomView] Error loading custom view:', error);

                // Fallback to local backup
                const backupKey = `microapp-backup-${project.id}-${viewName}`;
                const backup = localStorage.getItem(backupKey);
                if (backup) {
                    try {
                        const backupData = JSON.parse(backup);
                        setComponentCode(backupData.componentCode || '');
                        setCustomViewId(backupData.customViewId);
                    } catch (e) {
                        setComponentCode('');
                        console.error('[CustomView] Failed to parse backup after API error:', e);
                    }
                } else {
                    setComponentCode('');
                }

                showSnackbar('Failed to load custom view, using local backup if available', 'warning');
            } finally {
                setIsLoading(false);
            }
        };

        loadCustomView();
    }, [project?.id, viewName]);

    // Memoize component code for AssistantChat to prevent unnecessary re-renders
    const memoizedComponentCode = useMemo(() => {
        return componentCode && componentCode.trim() ? componentCode : null;
    }, [componentCode]);

    // Enhanced generation handling (optimized with useCallback)
    const handleSpaGenerated = useCallback((payload) => {
        if (typeof payload === 'string') {
            setComponentCode(payload);
            setGenerationProgress(null);
            showSnackbar('Micro-application generated successfully!', 'success');
            setIsLocked(false);
            return;
        }

        if (payload && payload.component_code) {
            setComponentCode(payload.component_code);
            setCustomViewId(payload.customViewId || payload.custom_view_id);
            setGenerationProgress(null);
            showSnackbar('Micro-application generated successfully!', 'success');
            setIsLocked(false);
            return;
        }

        if (payload && payload.html) {
            setComponentCode(payload.html);
            setCustomViewId(payload.customViewId);
            setGenerationProgress(null);
            showSnackbar('Micro-application generated successfully!', 'success');
            setIsLocked(false);
            return;
        }

        console.warn('Unexpected payload format:', payload);
        setGenerationProgress(null);
        showSnackbar('Generation completed but format was unexpected', 'warning');
    }, []);

    // Development logging helper (removed - was causing performance issues)

    const handleToggleLock = () => {
        setIsLocked(!isLocked);
        showSnackbar(isLocked ? 'Micro-application unlocked for editing' : 'Micro-application locked', 'info');
    };

    const handleRefresh = () => {
        window.location.reload();
    };

    const handleClearWorkingArea = async () => {
        // Clear local storage backups and any micro-app data
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && (key.includes(`microapp-`) || key.includes(`${project?.id}-${viewName}`))) {
                keysToRemove.push(key);
            }
        }
        keysToRemove.forEach(key => localStorage.removeItem(key));

        // If there's a saved custom view, try to delete it from server
        if (customViewId) {
            try {
                const response = await csrfFetch(`/projects/${project.id}/custom-views/delete`, {
                    method: 'DELETE',
                    body: JSON.stringify({
                        view_name: viewName,
                        custom_view_id: customViewId
                    }),
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showSnackbar('Micro-application deleted permanently', 'success');
                    } else {
                        showSnackbar('Micro-application cleared locally (server deletion failed)', 'warning');
                    }
                } else {
                    showSnackbar('Micro-application cleared locally (server deletion failed)', 'warning');
                }
            } catch (error) {
                console.error('[CustomView] Error deleting from server:', error);
                showSnackbar('Micro-application cleared locally (server unreachable)', 'warning');
            }
        } else {
            showSnackbar('Working area cleared', 'info');
        }

        // Reset local state
        setComponentCode('');
        setCustomViewId(null);
        setIsLocked(true);
        setDeleteConfirmOpen(false);
    };

    // Emergency recovery function to clear problematic component
    const handleEmergencyReset = useCallback(() => {
        console.warn('[CustomView] Emergency reset triggered');
        setComponentCode('');
        setCustomViewId(null);
        setComponentError(null);
        setIsLocked(true);

        // Clear local storage backups that might be causing issues
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && (key.includes(`microapp-`) || key.includes(`${project?.id}-${viewName}`))) {
                keysToRemove.push(key);
            }
        }
        keysToRemove.forEach(key => localStorage.removeItem(key));

        showSnackbar('Component reset. You can now generate a new micro-application.', 'info');
    }, [project?.id, viewName]);

    const handleComponentError = (error) => {
        console.error('[CustomView] Component error:', error);
        setComponentError(error);
        showSnackbar('Component error: ' + error, 'error');

        const e = String(error || '').toLowerCase();
        const isCritical =
            e.includes('already been declared') ||
            e.includes('syntaxerror') ||
            e.includes('freeze') ||
            e.includes('babel') ||
            e.includes('requires a filename');

        if (isCritical) {
            setTimeout(() => {
                setComponentCode('');
                setComponentError(null);
                showSnackbar(
                    'Component cleared due to critical error (e.g., Babel/preset/filename). Please regenerate.',
                    'warning'
                );
            }, 250);
        }
    };;

    const showSnackbar = (message, severity = 'info') => {
        setSnackbar({ open: true, message, severity });
    };

    const handleCloseSnackbar = () => {
        setSnackbar({ ...snackbar, open: false });
    };

    return (
        <AuthenticatedLayout
            user={auth.user}
        >
            <Head title={`Custom View: ${viewName} - ${project.name}`} />

            {/* Enhanced Generation Progress Dialog */}
            <Dialog
                open={!!generationProgress}
                disableEscapeKeyDown
                PaperProps={{
                    sx: {
                        borderRadius: designTokens.radii.xl,
                        minWidth: 400,
                        background: designTokens.gradients.primary,
                        boxShadow: designTokens.shadows.floating,
                    }
                }}
            >
                <DialogContent sx={{ p: 4, textAlign: 'center' }}>
                    <Stack spacing={3} alignItems="center">
                        <Box sx={{
                            width: 80,
                            height: 80,
                            borderRadius: '50%',
                            background: designTokens.gradients.accent,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: 'white',
                            fontSize: 32,
                            position: 'relative',
                            '&::after': {
                                content: '""',
                                position: 'absolute',
                                inset: -4,
                                borderRadius: '50%',
                                background: `linear-gradient(45deg, ${designTokens.colors.primary}, ${designTokens.colors.accent})`,
                                animation: `${shimmer} 2s infinite linear`,
                                zIndex: -1,
                                opacity: 0.5,
                            }
                        }}>
                            {getProgressIcon(generationProgress?.step)}
                        </Box>

                        <Box sx={{ width: '100%' }}>
                            <Typography variant="h6" fontWeight="600" color="text.primary" mb={1}>
                                {getProgressMessage(generationProgress?.step)}
                            </Typography>
                            <Typography variant="body2" color="text.secondary" mb={2}>
                                Step {generationProgress?.step || 1} of {generationProgress?.total || 4}
                            </Typography>
                            <LinearProgress
                                variant="determinate"
                                value={((generationProgress?.step || 1) / (generationProgress?.total || 4)) * 100}
                                sx={{
                                    height: 8,
                                    borderRadius: 4,
                                    backgroundColor: alpha(designTokens.colors.primary, 0.1),
                                    '& .MuiLinearProgress-bar': {
                                        borderRadius: 4,
                                        background: designTokens.gradients.accent,
                                    }
                                }}
                            />
                        </Box>
                    </Stack>
                </DialogContent>
            </Dialog>

            {/* Professional Main Container */}
            <Box sx={{
                background: designTokens.gradients.primary,
                minHeight: '100vh',
                p: 3
            }}>
                {/* Floating Control Panel */}
                <Paper
                    elevation={0}
                    sx={{
                        position: 'fixed',
                        bottom: 24,
                        right: 24,
                        zIndex: 1200,
                        borderRadius: designTokens.radii.xl,
                        background: alpha(theme.palette.background.paper, 0.95),
                        backdropFilter: 'blur(12px)',
                        border: `1px solid ${alpha(designTokens.colors.primary, 0.1)}`,
                        boxShadow: designTokens.shadows.floating,
                        overflow: 'hidden',
                        animation: `${fadeSlideUp} 0.6s ease-out`,
                    }}
                >
                    <Stack direction="column" spacing={0}>
                        {/* Generate Button */}
                        <Tooltip title={componentCode ? "Update Application" : "Generate New Application"} placement="left">
                            <IconButton
                                onClick={() => setAssistantOpen(true)}
                                sx={{
                                    p: 2,
                                    borderRadius: 0,
                                    background: designTokens.gradients.accent,
                                    color: 'white',
                                    '&:hover': {
                                        background: designTokens.gradients.accent,
                                        transform: 'scale(1.05)',
                                    },
                                    transition: 'all 0.2s ease',
                                }}
                            >
                                <AutoAwesomeIcon />
                            </IconButton>
                        </Tooltip>

                        {/* Save Button */}
                        {componentCode && (
                            <Tooltip title="Save Application" placement="left">
                                <IconButton
                                    onClick={handleManualSave}
                                    disabled={isSaving}
                                    sx={{
                                        p: 2,
                                        borderRadius: 0,
                                        color: designTokens.colors.success,
                                        borderTop: `1px solid ${alpha(theme.palette.divider, 0.1)}`,
                                        '&:hover': {
                                            background: alpha(designTokens.colors.success, 0.1),
                                        },
                                    }}
                                >
                                    {isSaving ? <CircularProgress size={20} /> : <SaveIcon />}
                                </IconButton>
                            </Tooltip>
                        )}

                        {/* Lock/Unlock */}
                        {componentCode && (
                            <Tooltip title={isLocked ? "Unlock for Editing" : "Lock Application"} placement="left">
                                <IconButton
                                    onClick={handleToggleLock}
                                    sx={{
                                        p: 2,
                                        borderRadius: 0,
                                        color: isLocked ? designTokens.colors.warning : designTokens.colors.primary,
                                        borderTop: `1px solid ${alpha(theme.palette.divider, 0.1)}`,
                                        '&:hover': {
                                            background: alpha(isLocked ? designTokens.colors.warning : designTokens.colors.primary, 0.1),
                                        },
                                    }}
                                >
                                    {isLocked ? <LockIcon /> : <LockOpenIcon />}
                                </IconButton>
                            </Tooltip>
                        )}

                        {/* Refresh */}
                        {componentCode && (
                            <Tooltip title="Refresh Application" placement="left">
                                <IconButton
                                    onClick={handleRefresh}
                                    sx={{
                                        p: 2,
                                        borderRadius: 0,
                                        color: theme.palette.text.secondary,
                                        borderTop: `1px solid ${alpha(theme.palette.divider, 0.1)}`,
                                        '&:hover': {
                                            background: alpha(theme.palette.text.secondary, 0.1),
                                        },
                                    }}
                                >
                                    <RefreshIcon />
                                </IconButton>
                            </Tooltip>
                        )}

                        {/* Delete */}
                        {componentCode && (
                            <Tooltip title="Delete Application" placement="left">
                                <IconButton
                                    onClick={() => setDeleteConfirmOpen(true)}
                                    sx={{
                                        p: 2,
                                        borderRadius: 0,
                                        color: designTokens.colors.error,
                                        borderTop: `1px solid ${alpha(theme.palette.divider, 0.1)}`,
                                        '&:hover': {
                                            background: alpha(designTokens.colors.error, 0.1),
                                        },
                                    }}
                                >
                                    <DeleteIcon />
                                </IconButton>
                            </Tooltip>
                        )}

                        {/* Emergency Reset - always visible when there's an error */}
                        {componentError && (
                            <Tooltip title="Emergency Reset (fixes freeze)" placement="left">
                                <IconButton
                                    onClick={handleEmergencyReset}
                                    sx={{
                                        p: 2,
                                        borderRadius: 0,
                                        color: 'white',
                                        background: designTokens.colors.error,
                                        borderTop: `1px solid ${alpha(theme.palette.divider, 0.1)}`,
                                        '&:hover': {
                                            background: designTokens.colors.error,
                                            transform: 'scale(1.05)',
                                        },
                                        animation: `${pulseGlow} 2s infinite`,
                                    }}
                                >
                                    <RefreshIcon />
                                </IconButton>
                            </Tooltip>
                        )}
                    </Stack>
                </Paper>

                {/* Enhanced Main Working Area */}
                <Paper
                    elevation={0}
                    sx={{
                        mt: 2,
                        mr: 10, // Space for floating controls
                        p: '5%', // 5% padding for working area
                        borderRadius: 3,
                        overflow: 'hidden',
                        background: alpha(theme.palette.background.paper, 0.8),
                        backdropFilter: 'blur(12px)',
                        border: isLocked
                            ? `2px solid ${designTokens.colors.success}`
                            : `2px dashed ${alpha(designTokens.colors.primary, 0.3)}`,
                        boxShadow: designTokens.shadows.elevated,
                        minHeight: 'calc(100vh - 200px)',
                        position: 'relative',
                        animation: `${fadeSlideUp} 0.8s ease-out`,
                    }}
                >
                    {componentCode && componentCode.trim() && !componentError ? (
                        <Box sx={{ position: 'relative' }}>
                            <ReactComponentRenderer
                                componentCode={componentCode}
                                project={project}
                                auth={auth}
                                viewName={viewName}
                                onError={handleComponentError}
                                tasks={tasks}
                                allTasks={allTasks}
                                users={users}
                                methodology={methodology}
                            />
                        </Box>
                    ) : isLoading ? (
                        <Box sx={{
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            justifyContent: 'center',
                            height: 'calc(100vh - 200px)',
                            color: 'text.secondary',
                        }}>
                            <Box sx={{
                                width: 60,
                                height: 60,
                                borderRadius: '50%',
                                background: designTokens.gradients.accent,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                color: 'white',
                                mb: 3,
                                animation: `${shimmer} 1.5s infinite linear`,
                            }}>
                                <AutoAwesomeIcon fontSize="large" />
                            </Box>
                            <Typography variant="h6" fontWeight="500" mb={1}>
                                Loading Application Studio...
                            </Typography>
                            <Typography variant="body2" color="text.secondary">
                                Preparing your custom application environment
                            </Typography>
                        </Box>
                    ) : (
                        <Box sx={{
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            justifyContent: 'center',
                            height: 'calc(100vh - 200px)',
                            p: 4,
                            textAlign: 'center',
                        }}>
                            <Box sx={{
                                width: 120,
                                height: 120,
                                borderRadius: designTokens.radii.xl,
                                background: designTokens.gradients.accent,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                color: 'white',
                                mb: 4,
                                cursor: 'pointer',
                                transition: 'all 0.3s ease',
                                '&:hover': {
                                    transform: 'scale(1.05)',
                                    boxShadow: designTokens.shadows.floating,
                                }
                            }}
                                onClick={() => setAssistantOpen(true)}
                            >
                                <AutoAwesomeIcon sx={{ fontSize: 48 }} />
                            </Box>

                            <Typography variant="h4" fontWeight="600" color="text.primary" mb={2}>
                                Ready to Create Something Amazing?
                            </Typography>
                            <Typography variant="body1" color="text.secondary" mb={4} maxWidth={600}>
                                Welcome to your custom application studio. Use AI to generate powerful,
                                data-driven micro-applications tailored to your project needs.
                            </Typography>

                            <Stack direction="row" spacing={2} flexWrap="wrap" justifyContent="center">
                                <Chip
                                    label="📊 Data Dashboard"
                                    variant="outlined"
                                    sx={{ borderRadius: designTokens.radii.lg }}
                                />
                                <Chip
                                    label="📋 Task Manager"
                                    variant="outlined"
                                    sx={{ borderRadius: designTokens.radii.lg }}
                                />
                                <Chip
                                    label="📈 Analytics View"
                                    variant="outlined"
                                    sx={{ borderRadius: designTokens.radii.lg }}
                                />
                                <Chip
                                    label="🎯 Custom Tool"
                                    variant="outlined"
                                    sx={{ borderRadius: designTokens.radii.lg }}
                                />
                            </Stack>

                            <Button
                                variant="contained"
                                size="large"
                                onClick={() => setAssistantOpen(true)}
                                startIcon={<AutoAwesomeIcon />}
                                sx={{
                                    mt: 4,
                                    borderRadius: designTokens.radii.lg,
                                    background: designTokens.gradients.accent,
                                    px: 4,
                                    py: 1.5,
                                    fontWeight: 600,
                                    boxShadow: designTokens.shadows.card,
                                    '&:hover': {
                                        background: designTokens.gradients.accent,
                                        transform: 'translateY(-2px)',
                                        boxShadow: designTokens.shadows.elevated,
                                    },
                                    transition: 'all 0.3s ease',
                                }}
                            >
                                Start Creating
                            </Button>
                        </Box>
                    )}
                </Paper>
            </Box>

            {/* Enhanced Delete Confirmation Dialog */}
            <Dialog
                open={deleteConfirmOpen}
                onClose={() => setDeleteConfirmOpen(false)}
                PaperProps={{
                    sx: {
                        borderRadius: 2,
                        background: designTokens.gradients.primary,
                    }
                }}
            >
                <DialogTitle sx={{ pb: 1 }}>
                    <Stack direction="row" alignItems="center" spacing={2}>
                        <Box sx={{
                            width: 40,
                            height: 40,
                            borderRadius: '50%',
                            background: alpha(designTokens.colors.error, 0.1),
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: designTokens.colors.error,
                        }}>
                            <DeleteIcon />
                        </Box>
                        <Typography variant="h6" fontWeight="600">
                            Delete Application
                        </Typography>
                    </Stack>
                </DialogTitle>
                <DialogContent>
                    <Typography color="text.secondary">
                        Are you sure you want to delete this custom application? This action cannot be undone.
                        All generated code and saved data will be permanently removed.
                    </Typography>
                </DialogContent>
                <DialogActions sx={{ p: 3, pt: 1 }}>
                    <Button
                        onClick={() => setDeleteConfirmOpen(false)}
                        sx={{ borderRadius: designTokens.radii.lg }}
                    >
                        Cancel
                    </Button>
                    <Button
                        onClick={handleClearWorkingArea}
                        variant="contained"
                        color="error"
                        sx={{
                            borderRadius: designTokens.radii.lg,
                            fontWeight: 600,
                        }}
                    >
                        Delete Permanently
                    </Button>
                </DialogActions>
            </Dialog>

            {/* Enhanced Assistant Chat Dialog */}
            <Dialog
                open={assistantOpen}
                onClose={() => setAssistantOpen(false)}
                maxWidth="md"
                fullWidth
                PaperProps={{
                    sx: {
                        borderRadius: 2,
                        background: designTokens.gradients.primary,
                        height: '80vh',
                        display: 'flex',
                        flexDirection: 'column',
                    }
                }}
            >
                <DialogTitle sx={{ pb: 1, borderBottom: 1, borderColor: 'divider' }}>
                    <Stack direction="row" alignItems="center" spacing={2}>
                        <AutoAwesomeIcon color="primary" />
                        <Typography variant="h6" fontWeight="600">
                            AI Component Generator
                        </Typography>
                        <Chip
                            label="Streaming AI"
                            size="small"
                            color="primary"
                            variant="outlined"
                        />
                    </Stack>
                </DialogTitle>

                <DialogContent sx={{ flex: 1, display: 'flex', flexDirection: 'column', p: 0 }}>
                    {/* Messages Display */}
                    <Box sx={{ flex: 1, overflow: 'auto', p: 2 }}>
                        {(messages?.length || 0) === 0 ? (
                            <Box textAlign="center" py={4}>
                                <AutoAwesomeIcon sx={{ fontSize: 48, color: 'primary.main', mb: 2 }} />
                                <Typography variant="h6" gutterBottom>
                                    Generate Custom Components with AI
                                </Typography>
                                <Typography variant="body2" color="text.secondary">
                                    Describe what you want to build and I'll create a React component for you
                                </Typography>
                            </Box>
                        ) : (
                            <Stack spacing={2}>
                                {messages?.map((message) => (
                                    <Box
                                        key={message?.id || Math.random()}
                                        sx={{
                                            display: 'flex',
                                            justifyContent: message?.role === 'user' ? 'flex-end' : 'flex-start',
                                        }}
                                    >
                                        <Paper
                                            sx={{
                                                p: 2,
                                                maxWidth: '70%',
                                                bgcolor: message?.role === 'user'
                                                    ? 'primary.main'
                                                    : 'background.paper',
                                                color: message?.role === 'user'
                                                    ? 'primary.contrastText'
                                                    : 'text.primary',
                                                borderRadius: 2,
                                            }}
                                        >
                                            <Typography variant="body2" sx={{ whiteSpace: 'pre-wrap' }}>
                                                {message?.content || ''}
                                            </Typography>
                                        </Paper>
                                    </Box>
                                )) || []}
                                {(isGenerating || isManuallyGenerating) && (
                                    <Box sx={{ display: 'flex', justifyContent: 'flex-start' }}>
                                        <Paper sx={{ p: 2, borderRadius: 2 }}>
                                            <Stack direction="row" spacing={1} alignItems="center">
                                                <CircularProgress size={16} />
                                                <Typography variant="body2" color="text.secondary">
                                                    Generating component...
                                                </Typography>
                                            </Stack>
                                        </Paper>
                                    </Box>
                                )}
                            </Stack>
                        )}
                    </Box>

                    {/* Input Form */}
                    <Box sx={{ p: 2, borderTop: 1, borderColor: 'divider' }}>
                        <form onSubmit={handleChatSubmit}>
                            <Stack direction="row" spacing={1}>
                                <TextField
                                    fullWidth
                                    value={chatInput}
                                    onChange={handleChatInputChange}
                                    placeholder="Describe the component you want to generate..."
                                    disabled={isGenerating}
                                    variant="outlined"
                                    size="small"
                                />
                                <Button
                                    type="submit"
                                    variant="contained"
                                    disabled={isGenerating || isManuallyGenerating || !chatInput?.trim()}
                                    startIcon={(isGenerating || isManuallyGenerating) ? <CircularProgress size={16} /> : <SendRoundedIcon />}
                                >
                                    {(isGenerating || isManuallyGenerating) ? 'Generating...' : 'Generate'}
                                </Button>
                                {(isGenerating || isManuallyGenerating) && (
                                    <Button
                                        variant="outlined"
                                        color="error"
                                        onClick={() => {
                                            if (typeof stop === 'function') {
                                                stop();
                                            }
                                            setIsManuallyGenerating(false);
                                        }}
                                    >
                                        Stop
                                    </Button>
                                )}
                            </Stack>
                        </form>

                        {chatError && (
                            <Alert severity="error" sx={{ mt: 1 }}>
                                {chatError.message}
                            </Alert>
                        )}
                    </Box>
                </DialogContent>

                <DialogActions sx={{ p: 2 }}>
                    <Button onClick={() => {
                        setMessages([]);
                        setChatInput('');
                    }}>
                        Clear Chat
                    </Button>
                    <Button onClick={() => setAssistantOpen(false)}>
                        Close
                    </Button>
                </DialogActions>
            </Dialog>

            {/* Legacy Assistant Chat - keeping for backup */}
            <AssistantChat
                project={project}
                tasks={tasks}
                allTasks={allTasks}
                users={users}
                methodology={methodology}
                viewName={viewName}
                open={false} // Disabled for now, using new streaming chat above
                onClose={() => setAssistantOpen(false)}
                isCustomView={true}
                onSpaGenerated={handleSpaGenerated}
                onProgressUpdate={setGenerationProgress}
                currentComponentCode={memoizedComponentCode}
            />

            {/* Enhanced Snackbar */}
            <Snackbar
                open={snackbar.open}
                autoHideDuration={4000}
                onClose={handleCloseSnackbar}
                anchorOrigin={{ vertical: 'bottom', horizontal: 'left' }}
            >
                <Alert
                    onClose={handleCloseSnackbar}
                    severity={snackbar.severity}
                    sx={{
                        width: '100%',
                        borderRadius: designTokens.radii.lg,
                        fontWeight: 500,
                    }}
                >
                    {snackbar.message}
                </Alert>
            </Snackbar>
        </AuthenticatedLayout>
    );
}
